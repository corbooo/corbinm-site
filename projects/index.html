<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link rel="icon" href="../assets/favicon.png" />
  <link rel="stylesheet" href="../assets/css/styles.css?v=1"/>
  <link rel="stylesheet" href="../assets/css/pages/projects.css?v=1"/>

  <title>Corbin - Projects</title>
</head>

<body>
  <header>
    <nav class="site-nav">
      <div class="nav-group nav-left">
        <a href="../assets/Resume.pdf" target="_blank" rel="noopener">Resume</a>
        <a href="https://github.com/corbooo" target="_blank" rel="noopener">GitHub</a>
        <a href="https://www.linkedin.com/in/corbinmoseman/" target="_blank" rel="noopener">LinkedIn</a>
      </div>

      <a class="nav-logo" href="../index.html" aria-label="Home">
        <img src="../assets/img/logo.png" alt="CM" />
      </a>

      <div class="nav-group nav-right">
        <a href="../about/">About</a>
        <a href="../projects/" class="active">Projects</a>
        <a href="../experience/">Experience</a>
      </div>
    </nav>
  </header>

  <main class="projects-page">
    <section class="projects-hero">
      <h1 class="projects-title">Projects</h1>
      <p class="projects-subtitle">
        A curated set of software builds focused on practical problem-solving: APIs, automation, data modeling, and polished UI.
      </p>

      <div class="filters" aria-label="Project filters">
        <div class="filters-left">
          <div class="input-wrap">
            <span class="input-icon" aria-hidden="true">⌕</span>
            <label class="sr-only" for="projectSearch">Search projects</label>
            <input id="projectSearch" type="search" placeholder="Search projects..." autocomplete="off" />
          </div>

          <label class="sr-only" for="projectSort">Sort projects</label>
          <select id="projectSort" class="select">
            <option value="featured">Featured first</option>
            <option value="newest">Newest</option>
            <option value="oldest">Oldest</option>
          </select>

          <button id="clearFilters" class="btn btn-primary" type="button">Clear</button>
        </div>

        <div id="chipRow" class="filters-right" aria-label="Skill filters">
          <!-- injected -->
        </div>
      </div>
    </section>

    <section class="projects-section" aria-label="Featured projects">
      <header class="section-head section-head-center">
        <h2 class="section-title">Featured</h2>
        <p class="section-note">Most polished, resume-ready builds.</p>
      </header>

      <div id="featuredGrid" class="row-grid"></div>
    </section>

    <div class="section-divider" role="separator" aria-hidden="true"></div>

    <section class="projects-section" aria-label="Mini projects">
      <header class="section-head section-head-row">
        <div>
          <h2 class="section-title">Mini Projects</h2>
          <p class="section-note">Smaller builds and experiments.</p>
        </div>

        <div class="slider-controls">
          <button id="miniPrev" class="icon-btn" type="button" aria-label="Scroll mini projects left">‹</button>
          <button id="miniNext" class="icon-btn" type="button" aria-label="Scroll mini projects right">›</button>
        </div>
      </header>

      <div id="miniSlider" class="slider" tabindex="0" aria-label="Mini projects slider"></div>

      <div id="emptyState" class="empty-state" hidden>
        No projects match your filters. Try clearing or changing tags.
      </div>
    </section>
  </main>

  <footer class="site-footer">
    <div class="footer-inner">
      <p class="footer-copy">© <span id="year"></span> Corbin Moseman</p>
      <div class="footer-links">
        <a href="mailto:corbinm@pobox.com">Email</a>
        <a href="https://github.com/corbooo" target="_blank" rel="noopener">GitHub</a>
        <a href="https://www.linkedin.com/in/corbinmoseman" target="_blank" rel="noopener">LinkedIn</a>
      </div>
    </div>
  </footer>

  <script>
    document.getElementById("year").textContent = new Date().getFullYear();

    const DATA_URL = "../assets/data/projects.json";

    const els = {
      search: document.getElementById("projectSearch"),
      sort: document.getElementById("projectSort"),
      chipRow: document.getElementById("chipRow"),
      clear: document.getElementById("clearFilters"),
      featuredGrid: document.getElementById("featuredGrid"),
      miniSlider: document.getElementById("miniSlider"),
      emptyState: document.getElementById("emptyState"),
      prev: document.getElementById("miniPrev"),
      next: document.getElementById("miniNext"),
    };

    const state = {
      q: "",
      skills: new Set(),
      sort: "featured",
      projects: [],
      allSkills: []
    };

    const norm = (s) => (s || "").toLowerCase().trim();

    function dateMs(p) {
      const t = Date.parse(p.date || "");
      return Number.isFinite(t) ? t : 0;
    }

    function computeSkills(projects) {
      const set = new Set();
      for (const p of projects) {
        for (const t of (p.tags || [])) set.add(t);
      }
      return [...set].sort((a, b) => a.localeCompare(b));
    }

    function renderChips(skills) {
      els.chipRow.innerHTML = "";
      for (const skill of skills) {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "chip";
        btn.textContent = skill;
        btn.dataset.skill = skill;
        btn.setAttribute("aria-pressed", "false");

        btn.addEventListener("click", () => {
          const s = btn.dataset.skill;
          if (state.skills.has(s)) state.skills.delete(s);
          else state.skills.add(s);

          const active = state.skills.has(s);
          btn.classList.toggle("chip--active", active);
          btn.setAttribute("aria-pressed", String(active));

          renderAll();
        });

        els.chipRow.appendChild(btn);
      }
    }

    function projectMatches(p) {
      const q = norm(state.q);
      const title = norm(p.title);
      const desc = norm(p.desc);
      const tags = norm((p.tags || []).join(" "));

      const searchOk = !q || title.includes(q) || desc.includes(q) || tags.includes(q);
      if (!searchOk) return false;

      if (state.skills.size === 0) return true;

      // OR match across selected skills
      for (const s of state.skills) {
        if (tags.includes(norm(s))) return true;
      }
      return false;
    }

    function sortProjects(list) {
      if (state.sort === "newest") return [...list].sort((a, b) => dateMs(b) - dateMs(a));
      if (state.sort === "oldest") return [...list].sort((a, b) => dateMs(a) - dateMs(b));
      // featured: keep JSON order
      return list;
    }

    function cardHTML(p, isMini) {
      const badge = p.tier === "featured" ? `<span class="badge">Featured</span>` : "";
      const pills = (p.tags || []).map(t => `<span class="tag">${t}</span>`).join("");

      const github = p.github
        ? `<a class="btn btn-primary" href="${p.github}" target="_blank" rel="noopener">GitHub</a>`
        : "";

      const live = p.live
        ? `<a class="btn btn-quiet" href="${p.live}" target="_blank" rel="noopener">Live</a>`
        : "";

      return `
        <article class="card ${isMini ? "card-mini" : ""}">
          <div class="card-title-row">
            <h3 class="card-title">${p.title}</h3>
            ${badge}
          </div>
          <p class="card-desc">${p.desc}</p>
          <div class="tag-row">${pills}</div>
          <div class="actions">${github}${live}</div>
        </article>
      `;
    }

    function renderAll() {
      const filtered = state.projects.filter(projectMatches);

      const featured = filtered.filter(p => p.tier === "featured");
      const mini = filtered.filter(p => p.tier !== "featured");

      const featuredSorted = state.sort === "featured" ? featured : sortProjects(featured);
      const miniSorted = state.sort === "featured" ? mini : sortProjects(mini);

      els.featuredGrid.innerHTML = featuredSorted.map(p => cardHTML(p, false)).join("");
      els.miniSlider.innerHTML = miniSorted.map(p => cardHTML(p, true)).join("");

      const visibleCount = featuredSorted.length + miniSorted.length;
      els.emptyState.hidden = visibleCount !== 0;

      els.miniSlider.scrollLeft = 0;
    }

    function wireUI() {
      els.search.addEventListener("input", (e) => {
        state.q = e.target.value || "";
        renderAll();
      });

      els.sort.addEventListener("change", (e) => {
        state.sort = e.target.value;
        renderAll();
      });

      els.clear.addEventListener("click", () => {
        state.q = "";
        state.skills.clear();
        state.sort = "featured";

        els.search.value = "";
        els.sort.value = "featured";
        els.chipRow.querySelectorAll(".chip").forEach(btn => {
          btn.classList.remove("chip--active");
          btn.setAttribute("aria-pressed", "false");
        });

        renderAll();
      });

      const scrollByCard = (dir) => {
        const first = els.miniSlider.querySelector(".card-mini");
        const amount = first ? (first.getBoundingClientRect().width + 16) : 360;
        els.miniSlider.scrollBy({ left: dir * amount, behavior: "smooth" });
      };

      els.prev.addEventListener("click", () => scrollByCard(-1));
      els.next.addEventListener("click", () => scrollByCard(1));
    }

    async function init() {
      wireUI();

      const res = await fetch(DATA_URL, { cache: "no-store" });
      const raw = await res.json();

      state.projects = (raw || []).map(p => ({
        id: p.id || "",
        title: p.title || "",
        desc: p.desc || "",
        tier: p.tier === "featured" ? "featured" : "mini",
        date: p.date || "",
        tags: Array.isArray(p.tags) ? p.tags : [],
        github: p.github || null,
        live: p.live || null
      }));

      state.allSkills = computeSkills(state.projects);
      renderChips(state.allSkills);
      renderAll();
    }

    init().catch(err => {
      console.error(err);
      els.featuredGrid.innerHTML = "<p>Could not load projects data.</p>";
    });
  </script>
</body>
</html>
